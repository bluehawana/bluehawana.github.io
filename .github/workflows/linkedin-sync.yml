name: LinkedIn Auto Sync

on:
  schedule:
    # Run every 30 minutes during business hours (8 AM - 8 PM UTC)
    # This is approximately 9 AM - 9 PM CET/10 AM - 10 PM CEST (Sweden time)
    - cron: '*/30 8-20 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-linkedin-posts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies (skip Chromium)
      env:
        PUPPETEER_SKIP_DOWNLOAD: 'true'
      run: |
        if [ -f package.json ]; then
          npm ci --omit=optional --no-audit --no-fund || npm install --no-audit --no-fund
        fi
        
    - name: Run LinkedIn sync with RapidAPI
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        SCRAPINGDOG_API_KEY: ${{ secrets.SCRAPINGDOG_API_KEY }}
        LINKEDIN_PROFILE_URN: ${{ secrets.LINKEDIN_PROFILE_URN }}
      run: |
        echo "ðŸš€ Starting LinkedIn sync via RapidAPI..."
        node automated-linkedin-sync-rapidapi.js || node automated-linkedin-sync-with-images.js || node automated-linkedin-sync.js
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "LinkedIn Sync Bot"

        # Add new files including images
        git add _posts/
        git add data/
        git add images/linkedin/ || true
        git add _data/

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "âœ… No new LinkedIn posts to sync"
        else
          echo "ðŸ“ Committing new LinkedIn posts with images..."
          NEW_POSTS=$(git diff --staged --name-only | grep "_posts" | wc -l || echo "0")
          NEW_IMAGES=$(git diff --staged --name-only | grep "images/linkedin" | wc -l || echo "0")
          git commit -m "ðŸ”„ Auto-sync LinkedIn posts - $(date '+%Y-%m-%d %H:%M UTC')

          ðŸ“ ${NEW_POSTS} new posts synced
          ðŸ–¼ï¸ ${NEW_IMAGES} images downloaded"
          git push
          echo "ðŸŽ‰ Successfully synced and pushed ${NEW_POSTS} posts with ${NEW_IMAGES} images!"
        fi

    - name: Generate sync report
      if: always()
      run: |
        echo "ðŸ“Š LinkedIn Sync Report - $(date)" >> $GITHUB_STEP_SUMMARY
        echo "================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count posts in _posts directory
        POST_COUNT=$(find _posts -name "*linkedin*" | wc -l)
        echo "ðŸ“ Total LinkedIn posts: $POST_COUNT" >> $GITHUB_STEP_SUMMARY
        
        # Show latest posts
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ†• Latest LinkedIn posts:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la _posts/*linkedin* | tail -5 >> $GITHUB_STEP_SUMMARY || echo "No LinkedIn posts found" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° Next sync: $(date -d '+6 hours' '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Automation is running smoothly!" >> $GITHUB_STEP_SUMMARY
